name: Random Riddle Extension - Build EXE Installer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (leave empty to auto-detect)'
        required: false
        type: string
      release_notes:
        description: 'What is new in this version'
        required: false
        default: 'New release with latest updates and improvements.'
        type: string

jobs:
  build:
    runs-on: windows-2022
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Install Inno Setup
      run: choco install innosetup -y --no-progress
      shell: pwsh
    
    - name: Get version from project
      id: version
      run: |
        if ("${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $projectFile = "CmdPalRandomRiddleExtension/CmdPalRandomRiddleExtension/CmdPalRandomRiddleExtension.csproj"
          $xml = [xml](Get-Content $projectFile)
          $version = $xml.Project.PropertyGroup.AppxPackageVersion | Select-Object -First 1
          if (-not $version) { throw "Version not found in project file" }
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        Write-Host "Using version: $version"
      shell: pwsh
    
    - name: Build EXE installers (x64 and ARM64)
      run: |
        Set-Location "CmdPalRandomRiddleExtension/CmdPalRandomRiddleExtension"
        .\build-exe.ps1 -Version "${{ steps.version.outputs.VERSION }}" -Platforms @("x64", "arm64")
      shell: pwsh
    
    - name: Upload x64 installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: RandomRiddleExtension-x64-installer
        path: CmdPalRandomRiddleExtension/CmdPalRandomRiddleExtension/bin/Release/installer/*-x64.exe
        if-no-files-found: error
    
    - name: Upload ARM64 installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: RandomRiddleExtension-arm64-installer
        path: CmdPalRandomRiddleExtension/CmdPalRandomRiddleExtension/bin/Release/installer/*-arm64.exe
        if-no-files-found: warn
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: RandomRiddle-v${{ steps.version.outputs.VERSION }}
        name: "Random Riddle Extension ${{ steps.version.outputs.VERSION }}"
        body: |
          # Random Riddle Extension ${{ steps.version.outputs.VERSION }}
          
          ## What's New
          ${{ github.event.inputs.release_notes }}
          
          ## System Requirements
          - Windows 10 version 2004 or later, or Windows 11
          - Microsoft PowerToys with Command Palette enabled
          
          ## Installation Instructions
          
          Download the installer for your system architecture:
          
          - **x64 (Intel/AMD)**: `CmdPalRandomRiddleExtension-Setup-${{ steps.version.outputs.VERSION }}-x64.exe`
          - **ARM64 (Windows on ARM)**: `CmdPalRandomRiddleExtension-Setup-${{ steps.version.outputs.VERSION }}-arm64.exe`
          
          1. Download the appropriate installer from the Assets section below
          2. Run the installer with administrator privileges
          3. The extension will be registered and available in Command Palette
          
          ## Known Issues
          - None reported for this version
          
          ---
          
          For more information, visit the [project repository](https://github.com/chatasweetie/CmdPalExtensions).
        files: CmdPalRandomRiddleExtension/CmdPalRandomRiddleExtension/bin/Release/installer/*.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build summary
      run: |
        Write-Host "üéâ Random Riddle Extension Release Complete!" -ForegroundColor Green
        Write-Host "Version: ${{ steps.version.outputs.VERSION }}" -ForegroundColor Yellow
        Write-Host "üìÅ Installer uploaded to GitHub Release" -ForegroundColor Green
      shell: pwsh